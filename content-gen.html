<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Content Generator ‚Äî Brand Collective</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3345;--text:#e8eaed;--text2:#9aa0b0;--accent:#3398FF;--accent2:#FF4B0F;--radius:12px;--shadow:0 4px 24px rgba(0,0,0,0.3)}
body{font-family:'Poppins',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:24px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;padding-bottom:20px;border-bottom:1px solid var(--border)}
header h1{font-size:24px;font-weight:600;display:flex;align-items:center;gap:10px}
header h1 span{color:var(--accent2)}
.badge{font-size:11px;background:var(--accent);color:#fff;padding:2px 8px;border-radius:20px;font-weight:500}
.theme-toggle{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px}
.layout{display:grid;grid-template-columns:400px 1fr;gap:24px;align-items:start}
@media(max-width:900px){.layout{grid-template-columns:1fr}}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px}
.panel h2{font-size:16px;font-weight:600;margin-bottom:16px;color:var(--text)}
label{display:block;font-size:13px;font-weight:500;color:var(--text2);margin-bottom:6px;margin-top:14px}
label:first-of-type{margin-top:0}
select,input,textarea{width:100%;padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:14px;outline:none;transition:border .2s}
select:focus,input:focus,textarea:focus{border-color:var(--accent)}
textarea{resize:vertical;min-height:70px}
.formats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
.format-btn{padding:10px;background:var(--surface2);border:2px solid var(--border);border-radius:8px;cursor:pointer;text-align:center;transition:all .2s;font-size:13px;color:var(--text)}
.format-btn:hover{border-color:var(--accent);background:var(--bg)}
.format-btn.active{border-color:var(--accent);background:rgba(51,152,255,0.1)}
.format-btn .dim{font-size:11px;color:var(--text2);margin-top:2px}
.colors-row{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.color-dot{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);cursor:pointer;transition:transform .15s}
.color-dot:hover{transform:scale(1.15)}
.generate-btn{width:100%;margin-top:20px;padding:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;transition:opacity .2s}
.generate-btn:hover{opacity:.9}
.generate-btn:disabled{opacity:.5;cursor:not-allowed}
.result-area{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px}
.result-area.empty{color:var(--text2);font-size:14px}
.result-area img{max-width:100%;border-radius:var(--radius);box-shadow:var(--shadow)}
.result-actions{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;justify-content:center}
.result-actions button{padding:10px 20px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:inherit;font-size:13px;cursor:pointer;font-weight:500}
.result-actions button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.status-msg{margin-top:12px;font-size:13px;color:var(--text2);text-align:center}
.error-msg{color:var(--accent2);text-align:center}
.api-key-row{display:flex;gap:8px}
.api-key-row input{flex:1}
.api-key-row button{padding:10px 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;white-space:nowrap}
.history{margin-top:16px}
.history h3{font-size:14px;color:var(--text2);margin-bottom:8px}
.history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.history-grid img{width:100%;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:border .2s}
.history-grid img:hover{border-color:var(--accent)}
.upload-area{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;color:var(--text2);font-size:13px}
.upload-area:hover,.upload-area.dragover{border-color:var(--accent);background:rgba(51,152,255,0.05)}
.key-status{font-size:11px;margin-top:6px;padding:4px 8px;border-radius:4px;display:inline-block}
.key-status.ok{color:#4ade80;background:rgba(74,222,128,0.1)}
.key-status.missing{color:var(--accent2);background:rgba(255,75,15,0.1)}
.toast{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:8px;font-size:13px;font-family:inherit;z-index:1000;animation:slideIn .3s ease;box-shadow:var(--shadow)}
.toast.success{background:#065f46;color:#6ee7b7;border:1px solid #10b981}
.toast.error{background:#7f1d1d;color:#fca5a5;border:1px solid #ef4444}
.toast.info{background:#1e3a5f;color:#93c5fd;border:1px solid #3b82f6}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.mode-hint{font-size:11px;color:var(--text2);margin-top:8px;padding:8px;background:var(--surface2);border-radius:6px;display:none}
.mode-hint.visible{display:block}
.light{--bg:#f5f6f8;--surface:#ffffff;--surface2:#f0f1f4;--border:#e0e2e8;--text:#1a1d27;--text2:#6b7280;--shadow:0 4px 24px rgba(0,0,0,0.08)}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>üé® <span>Content</span> Generator <span class="badge">v2</span></h1>
    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
  </header>
  <div class="layout">
    <div>
      <!-- API Key ‚Äî first, so users set it up before anything else -->
      <div class="panel">
        <h2>‚öôÔ∏è Google AI Studio Key</h2>
        <div class="api-key-row">
          <input id="googleKey" type="password" placeholder="AIza...">
          <button onclick="saveKey()">Save</button>
        </div>
        <div id="keyStatus"></div>
      </div>

      <div class="panel" style="margin-top:16px">
        <h2>Mode</h2>
        <div class="formats">
          <div class="format-btn active" data-mode="generate" onclick="selectMode('generate')">
            ‚ú® Generate<div class="dim">AI creates from brief</div>
          </div>
          <div class="format-btn" data-mode="resize" onclick="selectMode('resize')">
            üìê Resize Only<div class="dim">Fit image to new size</div>
          </div>
          <div class="format-btn" data-mode="ai-resize" onclick="selectMode('ai-resize')">
            ü™Ñ AI Reformat<div class="dim">AI extends to new ratio</div>
          </div>
        </div>
        <div class="mode-hint" id="modeHint"></div>
      </div>

      <div class="panel" style="margin-top:16px">
        <h2>Brand</h2>
        <select id="brand" onchange="loadBrand()">
          <option value="sns">Shoes & Sox</option>
          <option value="review">Review</option>
          <option value="blackpepper">Black Pepper</option>
          <option value="elka">Elka Collective</option>
          <option value="champion">Champion</option>
          <option value="superdry">Superdry</option>
          <option value="reebok">Reebok</option>
          <option value="hushpuppies">Hush Puppies</option>
          <option value="juliusmarlow">Julius Marlow</option>
          <option value="volley">Volley</option>
          <option value="clarks">Clarks</option>
          <option value="everlast">Everlast</option>
          <option value="yarratrail">Yarra Trail</option>
          <option value="shoewarehouse">Shoe Warehouse</option>
          <option value="umbro">Umbro</option>
          <option value="happysocks">Happy Socks</option>
          <option value="marcopolo">Marco Polo</option>
          <option value="harrison">Harrison</option>
          <option value="replay">Replay Jeans</option>
        </select>
        <label>Brand Colors</label>
        <div class="colors-row" id="colorsRow"></div>
      </div>

      <div class="panel" style="margin-top:16px" id="briefPanel">
        <h2>Brief</h2>
        <label>Campaign Name</label>
        <input id="campaign" placeholder="e.g. Back to School 2026">
        <label>Headline</label>
        <input id="headline" placeholder="e.g. Step Into the New Year">
        <label>Body Copy (optional)</label>
        <textarea id="body" placeholder="Supporting message or product details..."></textarea>
        <label>Product / Category Focus</label>
        <input id="product" placeholder="e.g. School shoes, Sneakers, Sandals">
        <label>Tone / Mood</label>
        <select id="tone">
          <option value="fun and playful">Fun & Playful</option>
          <option value="clean and modern">Clean & Modern</option>
          <option value="bold and energetic">Bold & Energetic</option>
          <option value="premium and sophisticated">Premium & Sophisticated</option>
          <option value="warm and family-friendly">Warm & Family-friendly</option>
        </select>
        <label>Additional Instructions (optional)</label>
        <textarea id="extra" rows="2" placeholder="e.g. Use orange background, add 20% OFF badge..."></textarea>
      </div>

      <div class="panel" style="margin-top:16px">
        <h2>Format</h2>
        <div class="formats" id="formats"></div>
        <div id="customDims" style="display:none;margin-top:10px">
          <div style="display:flex;gap:8px;align-items:center">
            <input id="customW" type="number" placeholder="Width" min="100" max="4096" style="width:50%">
            <span style="color:var(--text2)">√ó</span>
            <input id="customH" type="number" placeholder="Height" min="100" max="4096" style="width:50%">
            <span style="color:var(--text2);font-size:12px;white-space:nowrap">px</span>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:16px">
        <h2>üì∏ Reference Image <span id="imgRequired" style="font-size:11px;color:var(--text2)">(optional)</span></h2>
        <div class="upload-area" id="uploadArea">
          <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp,image/gif" style="display:none">
          <div id="uploadPlaceholder">
            <div style="font-size:28px;margin-bottom:8px">üìÅ</div>
            <div>Drop an image here or click to upload</div>
            <div style="font-size:11px;color:var(--text2);margin-top:4px">PNG, JPEG, WebP ‚Äî max 10MB</div>
          </div>
          <div id="uploadPreview" style="display:none">
            <img id="previewImg" style="max-width:100%;max-height:180px;border-radius:8px">
            <div id="imgInfo" style="font-size:11px;color:var(--text2);margin-top:4px"></div>
            <button id="removeBtn" style="margin-top:8px;padding:4px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text2);cursor:pointer;font-size:12px">‚úï Remove</button>
          </div>
        </div>
      </div>

      <button class="generate-btn" id="genBtn">‚ú® Generate Image</button>
    </div>

    <div>
      <div class="panel result-area" id="resultArea">
        <div class="result-area empty">
          <p>Generated images will appear here</p>
          <p style="margin-top:8px;font-size:12px">Select a brand, fill in your brief, choose a format, and hit Generate</p>
        </div>
      </div>
      <div class="history" id="historySection" style="display:none">
        <div class="panel">
          <h3>Recent Generations</h3>
          <div class="history-grid" id="historyGrid"></div>
          <button onclick="clearHistory()" style="margin-top:10px;padding:6px 12px;background:none;border:1px solid var(--border);border-radius:6px;color:var(--text2);cursor:pointer;font-size:11px">Clear history</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const BRANDS={
  sns:{name:"Shoes & Sox",colors:["#FF4B0F","#FDC145","#3398FF","#389810","#1E1E1E","#FFFFFF"],logo:"https://shoesandsox.com.au/cdn/shop/files/SNS_Logo_Responsive.svg",desc:"Australian children's footwear retailer"},
  review:{name:"Review",colors:["#000000","#C4A87C","#FFFFFF","#F5F0EB"],desc:"Women's fashion brand known for feminine, vintage-inspired designs"},
  blackpepper:{name:"Black Pepper",colors:["#000000","#FFFFFF","#8B6F4E"],desc:"Women's fashion brand for modern everyday style"},
  elka:{name:"Elka Collective",colors:["#000000","#FFFFFF","#C4A87C"],desc:"Premium contemporary women's fashion"},
  champion:{name:"Champion",colors:["#D50032","#003DA5","#FFFFFF","#000000"],desc:"Iconic sportswear and athletic apparel"},
  superdry:{name:"Superdry",colors:["#000000","#FF6600","#FFFFFF"],desc:"British-inspired fashion with Japanese graphics"},
  reebok:{name:"Reebok",colors:["#000000","#E41134","#FFFFFF"],desc:"Athletic footwear and apparel"},
  hushpuppies:{name:"Hush Puppies",colors:["#8B4513","#D2691E","#FFFFFF","#F5F0EB"],desc:"Casual comfort footwear"},
  juliusmarlow:{name:"Julius Marlow",colors:["#1A1A1A","#8B6F4E","#FFFFFF"],desc:"Men's footwear ‚Äî smart casual to formal"},
  volley:{name:"Volley",colors:["#003DA5","#FFD700","#FFFFFF","#008000"],desc:"Iconic Australian canvas sneakers"},
  clarks:{name:"Clarks",colors:["#000000","#8B4513","#FFFFFF"],desc:"Heritage footwear craftsmanship since 1825"},
  everlast:{name:"Everlast",colors:["#000000","#FF0000","#FFFFFF"],desc:"Boxing and fitness apparel"},
  yarratrail:{name:"Yarra Trail",colors:["#2C3E50","#8E6F5E","#FFFFFF","#F5F0EB"],desc:"Relaxed Australian women's fashion"},
  shoewarehouse:{name:"Shoe Warehouse",colors:["#FF0000","#000000","#FFFFFF","#FFD700"],desc:"Value footwear retailer"},
  umbro:{name:"Umbro",colors:["#000000","#FFFFFF","#003DA5"],desc:"Football and sportswear heritage brand"},
  happysocks:{name:"Happy Socks",colors:["#FF6B6B","#4ECDC4","#FFE66D","#2C3E50","#FFFFFF"],desc:"Colorful, playful socks and underwear"},
  marcopolo:{name:"Marco Polo",colors:["#000000","#8B6F4E","#FFFFFF","#2C3E50"],desc:"Relaxed women's fashion with natural fabrics"},
  harrison:{name:"Harrison",colors:["#000000","#8B4513","#FFFFFF"],desc:"Men's dress and business footwear"},
  replay:{name:"Replay Jeans",colors:["#000000","#C41230","#FFFFFF","#1A1A1A"],desc:"Italian denim and casual fashion"}
};

const FORMATS=[
  {id:"hero",name:"Hero Banner",w:1920,h:680},
  {id:"app",name:"App Banner",w:1200,h:628},
  {id:"social",name:"Social Post",w:1080,h:1080},
  {id:"collection",name:"Collection Tile",w:800,h:800},
  {id:"marketplace",name:"Marketplace",w:1440,h:400},
  {id:"story",name:"Story / Reel",w:1080,h:1920},
  {id:"custom",name:"Custom",w:0,h:0}
];

const MAX_UPLOAD_MB = 10;
const IMAGEN_MODEL = "imagen-4.0-ultra-generate-001";
const GEMINI_MODEL = "gemini-2.0-flash-exp-image-generation";
const GOOGLE_API_BASE = "https://generativelanguage.googleapis.com/v1beta/models";

/* ===== STATE ===== */
let selectedFormat = "hero";
let selectedMode = "generate";
let uploadedImageBase64 = null;
let uploadedImageMime = null;
let uploadedImageName = "";
let isGenerating = false;
let genHistory = [];

try { genHistory = JSON.parse(localStorage.getItem("cg_history") || "[]"); } catch(e) { genHistory = []; }

/* ===== TOAST NOTIFICATIONS ===== */
function toast(msg, type="info", duration=4000) {
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = "0"; el.style.transition = "opacity .3s"; setTimeout(() => el.remove(), 300); }, duration);
}

/* ===== SHOW ERROR IN RESULT AREA ===== */
function showError(msg, hint) {
  const ra = document.getElementById("resultArea");
  ra.innerHTML = `<div style="text-align:center">
    <p class="error-msg" style="font-size:15px">‚ùå ${escHtml(msg)}</p>
    ${hint ? `<p style="margin-top:8px;font-size:12px;color:var(--text2)">${escHtml(hint)}</p>` : ""}
    <button onclick="generate()" style="margin-top:16px;padding:8px 20px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-size:13px">Try Again</button>
  </div>`;
}

function escHtml(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }

/* ===== KEY MANAGEMENT ===== */
function saveKey() {
  const val = document.getElementById("googleKey").value.trim();
  if (!val) { toast("Enter a key first", "error"); return; }
  if (!val.startsWith("AIza")) { toast("Key should start with AIza...", "error"); return; }
  localStorage.setItem("cg_googlekey", val);
  toast("API key saved ‚úì", "success");
  updateKeyStatus();
}

function getKey() {
  return document.getElementById("googleKey").value.trim() || localStorage.getItem("cg_googlekey") || "";
}

function updateKeyStatus() {
  const el = document.getElementById("keyStatus");
  const key = getKey();
  if (key) {
    el.innerHTML = `<span class="key-status ok">‚úì Key saved (${key.slice(0,8)}...)</span>`;
  } else {
    el.innerHTML = `<span class="key-status missing">‚ö† No key ‚Äî get one free at <a href="https://aistudio.google.com" target="_blank" style="color:var(--accent)">aistudio.google.com</a></span>`;
  }
}

/* ===== BRAND ===== */
function loadBrand() {
  const b = BRANDS[document.getElementById("brand").value];
  if (!b) return;
  const row = document.getElementById("colorsRow");
  row.innerHTML = "";
  b.colors.forEach(c => {
    const dot = document.createElement("div");
    dot.className = "color-dot";
    dot.style.background = c;
    dot.title = c;
    dot.onclick = () => { navigator.clipboard.writeText(c).then(() => toast(`Copied ${c}`, "info", 1500)); };
    row.appendChild(dot);
  });
}

/* ===== FORMAT ===== */
function selectFormat(id) {
  selectedFormat = id;
  document.querySelectorAll("[data-fid]").forEach(el => {
    el.classList.toggle("active", el.dataset.fid === id);
  });
  document.getElementById("customDims").style.display = id === "custom" ? "block" : "none";
}

function getFormat() {
  let fmt = FORMATS.find(f => f.id === selectedFormat);
  if (!fmt) fmt = FORMATS[0];
  if (fmt.id === "custom") {
    const cw = parseInt(document.getElementById("customW").value) || 0;
    const ch = parseInt(document.getElementById("customH").value) || 0;
    if (cw < 100 || ch < 100 || cw > 4096 || ch > 4096) return null;
    return { ...fmt, w: cw, h: ch, name: `Custom ${cw}√ó${ch}` };
  }
  return fmt;
}

/* ===== MODE ===== */
function selectMode(m) {
  selectedMode = m;
  document.querySelectorAll("[data-mode]").forEach(el => {
    el.classList.toggle("active", el.dataset.mode === m);
  });

  const btn = document.getElementById("genBtn");
  const hint = document.getElementById("modeHint");
  const briefPanel = document.getElementById("briefPanel");
  const imgLabel = document.getElementById("imgRequired");

  if (m === "resize") {
    btn.textContent = "üìê Resize Image";
    hint.textContent = "Upload an image ‚Üí pick a format ‚Üí resize. No AI needed, instant result. Image is fit to target without cropping.";
    hint.classList.add("visible");
    briefPanel.style.display = "none";
    imgLabel.textContent = "(required)";
  } else if (m === "ai-resize") {
    btn.textContent = "ü™Ñ AI Reformat";
    hint.textContent = "Upload an image and the AI will intelligently adapt it to the new aspect ratio, extending or filling as needed.";
    hint.classList.add("visible");
    briefPanel.style.display = "block";
    imgLabel.textContent = "(required)";
  } else {
    btn.textContent = "‚ú® Generate Image";
    hint.textContent = "";
    hint.classList.remove("visible");
    briefPanel.style.display = "block";
    imgLabel.textContent = "(optional)";
  }
}

/* ===== IMAGE UPLOAD ===== */
function setupUpload() {
  const area = document.getElementById("uploadArea");
  const input = document.getElementById("fileInput");
  const removeBtn = document.getElementById("removeBtn");

  area.addEventListener("click", (e) => {
    if (e.target === removeBtn || removeBtn.contains(e.target)) return;
    input.click();
  });

  input.addEventListener("change", (e) => handleFiles(e.target.files));

  removeBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    clearUpload();
  });

  // Drag and drop
  ["dragenter", "dragover"].forEach(ev => area.addEventListener(ev, e => { e.preventDefault(); area.classList.add("dragover"); }));
  ["dragleave", "drop"].forEach(ev => area.addEventListener(ev, e => { e.preventDefault(); area.classList.remove("dragover"); }));
  area.addEventListener("drop", e => {
    const files = e.dataTransfer.files;
    if (files.length) handleFiles(files);
  });

  // Paste from clipboard
  document.addEventListener("paste", e => {
    const items = e.clipboardData?.items;
    if (!items) return;
    for (const item of items) {
      if (item.type.startsWith("image/")) {
        const file = item.getAsFile();
        if (file) handleFiles([file]);
        break;
      }
    }
  });
}

function handleFiles(files) {
  const file = files[0];
  if (!file) return;

  // Validate type
  if (!file.type.match(/^image\/(png|jpeg|webp|gif)$/)) {
    toast("Unsupported format ‚Äî use PNG, JPEG, or WebP", "error");
    return;
  }

  // Validate size
  if (file.size > MAX_UPLOAD_MB * 1024 * 1024) {
    toast(`Image too large ‚Äî max ${MAX_UPLOAD_MB}MB (yours: ${(file.size / 1024 / 1024).toFixed(1)}MB)`, "error");
    return;
  }

  const reader = new FileReader();
  reader.onload = (ev) => {
    const dataUrl = ev.target.result;
    uploadedImageMime = file.type;
    uploadedImageBase64 = dataUrl.split(",")[1];
    uploadedImageName = file.name;

    const preview = document.getElementById("previewImg");
    preview.src = dataUrl;
    preview.onload = () => {
      document.getElementById("imgInfo").textContent = `${file.name} ‚Äî ${preview.naturalWidth}√ó${preview.naturalHeight} ‚Äî ${(file.size/1024).toFixed(0)}KB`;
    };

    document.getElementById("uploadPlaceholder").style.display = "none";
    document.getElementById("uploadPreview").style.display = "block";
    toast("Image uploaded ‚úì", "success", 2000);
  };
  reader.onerror = () => toast("Failed to read image", "error");
  reader.readAsDataURL(file);
}

function clearUpload() {
  uploadedImageBase64 = null;
  uploadedImageMime = null;
  uploadedImageName = "";
  document.getElementById("fileInput").value = "";
  document.getElementById("uploadPlaceholder").style.display = "block";
  document.getElementById("uploadPreview").style.display = "none";
}

/* ===== CLIENT-SIDE RESIZE ===== */
function resizeImage(fmt) {
  return new Promise((resolve, reject) => {
    if (!uploadedImageBase64) { reject(new Error("Upload an image first")); return; }
    const img = new Image();
    img.onload = () => {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = fmt.w;
        canvas.height = fmt.h;
        const ctx = canvas.getContext("2d");

        // Background: blurred scaled version of the image
        ctx.save();
        ctx.filter = "blur(40px)";
        const bgScale = Math.max(fmt.w / img.width, fmt.h / img.height) * 1.2;
        const bgW = img.width * bgScale, bgH = img.height * bgScale;
        ctx.drawImage(img, (fmt.w - bgW) / 2, (fmt.h - bgH) / 2, bgW, bgH);
        ctx.restore();

        // Darken overlay
        ctx.fillStyle = "rgba(0,0,0,0.15)";
        ctx.fillRect(0, 0, fmt.w, fmt.h);

        // Contain-fit (no crop, full image visible)
        const scale = Math.min(fmt.w / img.width, fmt.h / img.height);
        const dw = img.width * scale, dh = img.height * scale;
        const dx = (fmt.w - dw) / 2, dy = (fmt.h - dh) / 2;
        ctx.drawImage(img, 0, 0, img.width, img.height, dx, dy, dw, dh);

        resolve(canvas.toDataURL("image/png"));
      } catch (err) {
        reject(new Error("Resize failed: " + err.message));
      }
    };
    img.onerror = () => reject(new Error("Failed to load image for resize"));
    img.src = `data:${uploadedImageMime || "image/png"};base64,${uploadedImageBase64}`;
  });
}

/* ===== PROMPT BUILDER ===== */
function buildPrompt(brand, fmt, fields, hasImage) {
  const { campaign, headline, body, product, tone, extra } = fields;
  return `${hasImage ? "Reformat and restyle the provided reference image as a" : "Create a"} professional promotional banner image for ${brand.name} (${brand.desc}).${hasImage ? "\nUse the uploaded image as the primary visual reference. Maintain the key subject/product from the image but adapt it to fit the target format and brand style." : ""}

BRAND GUIDELINES:
- Brand colors: ${brand.colors.join(", ")}
- Design style: ${tone}
- Include the brand name "${brand.name}" as text in the design

CONTENT:
${campaign ? `- Campaign: ${campaign}` : ""}
${headline ? `- Headline text: "${headline}"` : ""}
${body ? `- Supporting copy: "${body}"` : ""}
${product ? `- Product/category focus: ${product}` : ""}

REQUIREMENTS:
- Dimensions: ${fmt.w}x${fmt.h} pixels (${fmt.w > fmt.h ? "landscape" : fmt.w === fmt.h ? "square" : "portrait"} orientation)
- Make it retail-ready and professional
- Use the brand colors as the primary palette
- Text should be legible and well-positioned
- Clean, modern design suitable for web/digital use
${extra ? `- Additional instructions: ${extra}` : ""}

This is for a major Australian retail brand. The image must look polished and commercially viable.`;
}

/* ===== IMAGEN 4 ULTRA (text-to-image) ===== */
async function callImagen(prompt, fmt, key) {
  const ratio = fmt.w / fmt.h;
  let aspectRatio = "1:1";
  if (ratio > 1.6) aspectRatio = "16:9";
  else if (ratio > 1.2) aspectRatio = "4:3";
  else if (ratio > 0.9) aspectRatio = "1:1";
  else if (ratio > 0.6) aspectRatio = "3:4";
  else aspectRatio = "9:16";

  const resp = await fetchWithTimeout(`${GOOGLE_API_BASE}/${IMAGEN_MODEL}:predict?key=${key}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      instances: [{ prompt }],
      parameters: { sampleCount: 1, aspectRatio }
    })
  }, 60000);

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    const msg = err.error?.message || `Imagen API error (${resp.status})`;
    if (resp.status === 403 || msg.includes("billed")) throw new Error("Imagen requires a billed Google Cloud account. Enable billing at console.cloud.google.com");
    if (resp.status === 429) throw new Error("Rate limited ‚Äî wait a moment and try again");
    if (resp.status === 400 && msg.includes("safety")) throw new Error("Content blocked by safety filter ‚Äî try different wording");
    throw new Error(msg);
  }

  const data = await resp.json();
  const predictions = data.predictions || [];
  if (!predictions.length) throw new Error("No image returned ‚Äî the model may have filtered this prompt. Try different wording.");
  const b64 = predictions[0].bytesBase64Encoded;
  if (!b64) throw new Error("Empty image data in response");
  return `data:image/png;base64,${b64}`;
}

/* ===== GEMINI (image-to-image, for AI reformat with uploaded image) ===== */
async function callGeminiWithImage(prompt, key) {
  const parts = [
    { text: prompt },
    { inlineData: { mimeType: uploadedImageMime || "image/png", data: uploadedImageBase64 } }
  ];

  const resp = await fetchWithTimeout(`${GOOGLE_API_BASE}/${GEMINI_MODEL}:generateContent?key=${key}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      contents: [{ parts }],
      generationConfig: { responseModalities: ["TEXT", "IMAGE"], responseMimeType: "text/plain" }
    })
  }, 60000);

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    const msg = err.error?.message || `Gemini API error (${resp.status})`;
    if (resp.status === 429) throw new Error("Rate limited ‚Äî wait 30 seconds and try again");
    throw new Error(msg);
  }

  const data = await resp.json();
  const resParts = data.candidates?.[0]?.content?.parts || [];
  const imgPart = resParts.find(p => p.inlineData);
  if (!imgPart) {
    const textPart = resParts.find(p => p.text);
    throw new Error(textPart ? `AI couldn't generate image: ${textPart.text.slice(0, 100)}` : "No image returned ‚Äî try a different prompt");
  }
  return `data:${imgPart.inlineData.mimeType};base64,${imgPart.inlineData.data}`;
}

/* ===== FETCH WITH TIMEOUT ===== */
function fetchWithTimeout(url, options, timeoutMs) {
  return Promise.race([
    fetch(url, options),
    new Promise((_, reject) => setTimeout(() => reject(new Error(`Request timed out after ${timeoutMs / 1000}s ‚Äî try again`)), timeoutMs))
  ]);
}

/* ===== MAIN GENERATE ===== */
async function generate() {
  if (isGenerating) { toast("Already generating ‚Äî please wait", "info"); return; }

  const btn = document.getElementById("genBtn");
  const resultArea = document.getElementById("resultArea");

  try {
    isGenerating = true;
    btn.disabled = true;

    // Get format (validates custom dims)
    const fmt = getFormat();
    if (!fmt) {
      showError("Invalid dimensions", "Custom size must be between 100 and 4096 pixels");
      return;
    }

    // === RESIZE MODE (no AI) ===
    if (selectedMode === "resize") {
      if (!uploadedImageBase64) { showError("No image uploaded", "Upload an image first, then resize"); return; }
      btn.textContent = "‚è≥ Resizing...";
      resultArea.innerHTML = `<div class="spinner"></div><div class="status-msg">Resizing to ${fmt.w}√ó${fmt.h}...</div>`;

      const imgSrc = await resizeImage(fmt);
      showResult(imgSrc, `Resized to ${fmt.w}√ó${fmt.h}`, "Resize");
      addToHistory(imgSrc, "Resize", `${fmt.w}√ó${fmt.h}`, fmt.name, "Client");
      return;
    }

    // === AI MODES (need API key) ===
    const key = getKey();
    if (!key) {
      showError("No API key", "Paste your Google AI Studio key above and hit Save. Get one free at aistudio.google.com");
      return;
    }

    const brand = BRANDS[document.getElementById("brand").value];
    if (!brand) { showError("Select a brand"); return; }

    const fields = {
      campaign: document.getElementById("campaign").value.trim(),
      headline: document.getElementById("headline").value.trim(),
      body: document.getElementById("body").value.trim(),
      product: document.getElementById("product").value.trim(),
      tone: document.getElementById("tone").value,
      extra: document.getElementById("extra").value.trim()
    };

    // === AI REFORMAT MODE ===
    if (selectedMode === "ai-resize") {
      if (!uploadedImageBase64) { showError("No image uploaded", "AI Reformat needs a source image to work with"); return; }
      btn.textContent = "‚è≥ Reformatting...";
      resultArea.innerHTML = `<div class="spinner"></div><div class="status-msg">AI is reformatting your image to ${fmt.w}√ó${fmt.h}...</div>`;

      // Simple reformat prompt ‚Äî preserve the image, just change dimensions
      const reformatPrompt = `Reformat this image to a ${fmt.w}x${fmt.h} pixel ${fmt.w > fmt.h ? "landscape" : fmt.w === fmt.h ? "square" : "portrait"} layout. Keep the subject, composition, and style as close to the original as possible. Extend or fill the background naturally where needed to fit the new aspect ratio. Do not add new elements, text, or graphics. Do not change the style or mood.${fields.extra ? " " + fields.extra : ""}`;

      const imgSrc = await callGeminiWithImage(reformatPrompt, key);
      showResult(imgSrc, `Reformatted to ${fmt.w}√ó${fmt.h}`, "Gemini");
      addToHistory(imgSrc, brand.name, "Reformat", fmt.name, "Gemini");
      return;
    }

    // === GENERATE MODE ===
    // No required fields ‚Äî user can generate with just brand + format + tone

    const hasImage = !!uploadedImageBase64;
    btn.textContent = "‚è≥ Generating...";

    let imgSrc;
    if (hasImage) {
      // Generate mode + image: user wants AI to use their image as inspiration, but generate fresh
      resultArea.innerHTML = `<div class="spinner"></div><div class="status-msg">Generating from your image for ${brand.name}...</div>`;
      const imgPrompt = `Using the provided image as a reference, create a new ${fmt.w}x${fmt.h} ${fmt.w > fmt.h ? "landscape" : fmt.w === fmt.h ? "square" : "portrait"} promotional banner for ${brand.name}. Keep the same subject and visual theme from the reference image.${fields.campaign ? " Campaign: " + fields.campaign : ""}${fields.headline ? ' Headline: "' + fields.headline + '"' : ""}${fields.product ? " Product focus: " + fields.product : ""}${fields.extra ? " " + fields.extra : ""} Professional, retail-ready, clean design.`;
      imgSrc = await callGeminiWithImage(imgPrompt, key);
    } else {
      // Pure text-to-image via Imagen 4 Ultra
      resultArea.innerHTML = `<div class="spinner"></div><div class="status-msg">Creating ${fmt.name} for ${brand.name} via Imagen 4 Ultra...</div>`;
      const prompt = buildPrompt(brand, fmt, fields, false);
      imgSrc = await callImagen(prompt, fmt, key);
    }
    showResult(imgSrc, `Generated with ${modelName}`, modelName);
    addToHistory(imgSrc, brand.name, fields.campaign || fields.headline, fmt.name, modelName);

  } catch (e) {
    console.error("Generate error:", e);
    showError(e.message || "Unknown error", "Check the console for details");
  } finally {
    isGenerating = false;
    btn.disabled = false;
    // Restore button text based on mode
    if (selectedMode === "resize") btn.textContent = "üìê Resize Image";
    else if (selectedMode === "ai-resize") btn.textContent = "ü™Ñ AI Reformat";
    else btn.textContent = "‚ú® Generate Image";
  }
}

/* ===== SHOW RESULT ===== */
function showResult(imgSrc, statusText, model) {
  const resultArea = document.getElementById("resultArea");
  resultArea.innerHTML = `<img src="${imgSrc}" alt="Generated image">
    <div class="result-actions">
      <button class="primary" onclick="downloadImg()">‚¨áÔ∏è Download</button>
      <button onclick="generate()">üîÑ Regenerate</button>
    </div>
    <div class="status-msg">${escHtml(statusText)}</div>`;
}

/* ===== DOWNLOAD ===== */
function downloadImg() {
  const img = document.querySelector("#resultArea img");
  if (!img || !img.src) { toast("No image to download", "error"); return; }
  const a = document.createElement("a");
  a.href = img.src;
  const brand = document.getElementById("brand").value;
  a.download = `${brand}-${selectedFormat}-${Date.now()}.png`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

/* ===== HISTORY ===== */
function addToHistory(src, brand, campaign, format, model) {
  // Don't store huge base64 blobs if localStorage is full
  try {
    genHistory.unshift({ src, brand, campaign, format, model, time: Date.now() });
    if (genHistory.length > 8) genHistory = genHistory.slice(0, 8);
    localStorage.setItem("cg_history", JSON.stringify(genHistory));
  } catch (e) {
    // localStorage full ‚Äî trim history
    genHistory = genHistory.slice(0, 3);
    try { localStorage.setItem("cg_history", JSON.stringify(genHistory)); } catch (e2) {
      genHistory = [];
      try { localStorage.removeItem("cg_history"); } catch (e3) {}
    }
  }
  renderHistory();
}

function renderHistory() {
  const section = document.getElementById("historySection");
  const grid = document.getElementById("historyGrid");
  if (!genHistory.length) { section.style.display = "none"; return; }
  section.style.display = "block";
  grid.innerHTML = "";
  genHistory.forEach((h, i) => {
    const img = document.createElement("img");
    img.src = h.src;
    img.title = `${h.brand} ‚Äî ${h.campaign} (${h.format})`;
    img.loading = "lazy";
    img.onclick = () => showHistoryItem(i);
    img.onerror = () => img.remove(); // Remove broken thumbnails
    grid.appendChild(img);
  });
}

function showHistoryItem(i) {
  const h = genHistory[i];
  if (!h) return;
  showResult(h.src, `${h.brand} ‚Äî ${h.campaign} (${h.format})`, h.model);
}

function clearHistory() {
  genHistory = [];
  try { localStorage.removeItem("cg_history"); } catch (e) {}
  renderHistory();
  toast("History cleared", "info", 1500);
}

/* ===== THEME ===== */
function toggleTheme() {
  document.body.classList.toggle("light");
  const isLight = document.body.classList.contains("light");
  document.querySelector(".theme-toggle").textContent = isLight ? "‚òÄÔ∏è" : "üåô";
  try { localStorage.setItem("cg_theme", isLight ? "light" : "dark"); } catch (e) {}
}

/* ===== INIT ===== */
function init() {
  // Formats
  const fmtDiv = document.getElementById("formats");
  FORMATS.forEach(f => {
    const btn = document.createElement("div");
    btn.className = `format-btn ${f.id === selectedFormat ? "active" : ""}`;
    btn.dataset.fid = f.id;
    btn.innerHTML = `${f.name}<div class="dim">${f.id === "custom" ? "Any size" : `${f.w}√ó${f.h}`}</div>`;
    btn.onclick = () => selectFormat(f.id);
    fmtDiv.appendChild(btn);
  });

  // Load saved key
  const savedKey = localStorage.getItem("cg_googlekey") || "";
  document.getElementById("googleKey").value = savedKey;
  updateKeyStatus();

  // Load saved theme
  const savedTheme = localStorage.getItem("cg_theme");
  if (savedTheme === "light") { document.body.classList.add("light"); document.querySelector(".theme-toggle").textContent = "‚òÄÔ∏è"; }

  // Setup
  loadBrand();
  setupUpload();
  renderHistory();

  // Generate button
  document.getElementById("genBtn").addEventListener("click", generate);

  // Enter key on inputs triggers generate
  ["campaign", "headline", "product"].forEach(id => {
    document.getElementById(id).addEventListener("keydown", e => { if (e.key === "Enter") generate(); });
  });

  console.log("Content Generator v2 initialized");
}

init();
</script>
</body>
</html>